<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face & Pose Tracking + Spline (Low-Res Optimized)</title>

    <!-- External Dependencies -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: monospace;
        }

        #loader-overlay {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease;
        }

        #loader-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #canvas3d {
            position: fixed;
            inset: 0;
            z-index: 1;
        }

        #video-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 320px;
            height: 240px;
            z-index: 100;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #videoFeed {
            display: none;
        }

        #outputCanvas {
            width: 100%;
            height: 100%;
        }

        #label-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            padding: 6px;
            font-size: 12px;
            color: white;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }

        .label-bar-bg {
            width: 60px;
            height: 4px;
            background: rgba(255,255,255,0.2);
        }

        .label-bar-fill {
            height: 100%;
            background: #4facfe;
            width: 0%;
        }
    </style>
</head>

<body>

<div id="loader-overlay">
    <div>
        <lottie-player src="preload.json" style="width:300px;height:300px" loop autoplay></lottie-player>
        <div id="loading-text" style="color:white;text-align:center">Initializing…</div>
    </div>
</div>

<div id="video-overlay">
    <video id="videoFeed" autoplay playsinline muted></video>
    <canvas id="outputCanvas"></canvas>
    <div id="label-container"></div>
</div>

<canvas id="canvas3d"></canvas>

<!-- LOW-RES PROCESSING CANVAS -->
<canvas id="processCanvas" style="display:none;"></canvas>

<script async src="https://docs.opencv.org/4.7.0/opencv.js" onload="onOpenCvReady()"></script>

<script type="module">
import { Application } from 'https://unpkg.com/@splinetool/runtime@1.9.54/build/runtime.js';

const CONFIG = {
    FACE_CASCADE_URL: 'haarcascade_frontalface_default.xml',
    SCENE_URL: 'https://prod.spline.design/yYS1xtlWqP5R7SwT/scene.splinecode',
    CAMERA_ID: '56c30b36-44df-48b7-89f1-27070018dad0',
    TM_MODEL_URL: 'https://teachablemachine.withgoogle.com/models/odgkAY81j/'
};

const state = {
    cvReady: false,
    splineReady: false,
    tmReady: false,
    cameraReady: false,
    appStarted: false,
    rightHandTriggered: false
};

let video, outputCanvas, outputCtx;
let processCanvas, processCtx;
let classifier;
let tmModel, maxPredictions;

async function checkReady() {
    if (state.cvReady && state.splineReady && state.tmReady && state.cameraReady && !state.appStarted) {
        state.appStarted = true;
        document.getElementById('loader-overlay').classList.add('fade-out');
        requestAnimationFrame(faceLoop);
        requestAnimationFrame(poseLoop);
    }
}

// -------- Spline --------
async function initSpline() {
    const app = new Application(document.getElementById('canvas3d'), {
        autoRender: true,
        autoResize: true,
        controls: false
    });

    await app.load(CONFIG.SCENE_URL);
    window.splineApp = app;

    window.splineCamera = app.findObjectById(CONFIG.CAMERA_ID) ||
        app.getAllObjects().find(o => o.type.includes('Camera'));

    state.splineReady = true;
    checkReady();
}

// -------- OpenCV --------
window.onOpenCvReady = async () => {
    classifier = new cv.CascadeClassifier();
    const res = await fetch(CONFIG.FACE_CASCADE_URL);
    const data = new Uint8Array(await res.arrayBuffer());
    cv.FS_createDataFile('/', CONFIG.FACE_CASCADE_URL, data, true, false);
    classifier.load(CONFIG.FACE_CASCADE_URL);
    state.cvReady = true;
    checkReady();
};

// -------- Webcam --------
async function initWebcam() {
    video = document.getElementById('videoFeed');
    outputCanvas = document.getElementById('outputCanvas');
    outputCtx = outputCanvas.getContext('2d');

    processCanvas = document.getElementById('processCanvas');
    processCanvas.width = 320;
    processCanvas.height = 240;
    processCtx = processCanvas.getContext('2d');

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 480, facingMode: 'user' }
    });

    video.srcObject = stream;
    await video.play();

    outputCanvas.width = 640;
    outputCanvas.height = 480;

    state.cameraReady = true;
    checkReady();
}

// -------- Teachable Machine --------
async function initTM() {
    tmModel = await tmPose.load(
        CONFIG.TM_MODEL_URL + 'model.json',
        CONFIG.TM_MODEL_URL + 'metadata.json'
    );
    maxPredictions = tmModel.getTotalClasses();

    const container = document.getElementById('label-container');
    for (let i = 0; i < maxPredictions; i++) {
        container.innerHTML += `
            <div class="label-row">
                <span class="label-text">—</span>
                <div class="label-bar-bg"><div class="label-bar-fill"></div></div>
            </div>`;
    }

    state.tmReady = true;
    checkReady();
}

// -------- Face Tracking (LOW-RES OpenCV) --------
function faceLoop() {
    if (!state.appStarted) return;

    processCtx.save();
    processCtx.scale(-1, 1);
    processCtx.drawImage(video, -320, 0, 320, 240);
    processCtx.restore();

    outputCtx.drawImage(video, 0, 0, 640, 480);

    let src = cv.imread(processCanvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    const faces = new cv.RectVector();
    classifier.detectMultiScale(gray, faces, 1.1, 3, 0);

    if (faces.size() > 0) {
        const f = faces.get(0);
        const scaleX = 640 / 320;
        const scaleY = 480 / 240;

        const cx = (f.x + f.width / 2) * scaleX;
        const cy = (f.y + f.height / 2) * scaleY;

        updateCamera(cx / 640 * 2 - 1, cy / 480 * 2 - 1);
    }

    src.delete(); gray.delete(); faces.delete();
    requestAnimationFrame(faceLoop);
}

// -------- Pose --------
async function poseLoop() {
    if (!state.appStarted) return;

    const { posenetOutput } = await tmModel.estimatePose(video);
    const preds = await tmModel.predict(posenetOutput);

    const rows = document.querySelectorAll('.label-row');
    preds.forEach((p, i) => {
        rows[i].querySelector('.label-text').innerText =
            `${p.className}: ${(p.probability * 100).toFixed(0)}%`;
        rows[i].querySelector('.label-bar-fill').style.width =
            `${p.probability * 100}%`;
    });

    requestAnimationFrame(poseLoop);
}

// -------- Camera Control --------
function updateCamera(nx, ny) {
    if (!window.splineCamera) return;

    const strengthX = 0.4;
    const strengthY = 0.3;

    splineCamera.rotation.y += -nx * strengthX * 0.1;
    splineCamera.rotation.x += -ny * strengthY * 0.1;
}

// -------- Init --------
initSpline();
initWebcam();
initTM();

</script>
</body>
</html>